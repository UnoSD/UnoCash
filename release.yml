pool:
  vmImage: ubuntu-latest

steps:

- task: AzureCLI@2
  displayName: Create Pulumi backend storage account
    env:
      AZURE_KEYVAULT_AUTH_VIA_CLI: true
      PULUMI_CONFIG_PASSPHRASE: ""
      ARM_CLIENT_ID: "$servicePrincipalId"
      ARM_CLIENT_SECRET: "$servicePrincipalKey"
      ARM_SUBSCRIPTION_ID: $(az account show --query id -o tsv)
      ARM_TENANT_ID: "$tenantId"
      PATH: "$PATH:/home/vsts/.pulumi/bin"
      AZURE_STORAGE_ACCOUNT: $(backend-storage-account-name)
  inputs:
    azureSubscription: $(azure-subscription)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      az group create -l westeurope -n Pulumi
      az storage account create -n $(backend-storage-account-name) -g Pulumi -l westeurope --sku Standard_LRS
      az storage container create -n unocash --account-name $(backend-storage-account-name)
      az keyvault create --location westeurope --name $(secrets-provider-keyvault-name) --resource-group Pulumi
      az keyvault set-policy --name unocashpulumi --key-permissions backup create decrypt delete encrypt get import list purge recover restore sign unwrapKey update verify wrapKey --object-id $(az ad sp show --id $servicePrincipalId --query objectId -o tsv)
      az keyvault key create --name pulumi --vault-name $(secrets-provider-keyvault-name)
      
      export SAS_END=$(date -u -d "30 minutes" '+%Y-%m-%dT%H:%MZ')
      export AZURE_STORAGE_SAS_TOKEN=$(az storage account generate-sas --permissions cdlruwap --account-name $(backend-storage-account-name) --services b --resource-types sco --expiry $SAS_END -o tsv)
      echo "##vso[task.setvariable variable=AZURE_STORAGE_ACCOUNT]$(backend-storage-account-name)"
      echo "##vso[task.setvariable variable=AZURE_STORAGE_SAS_TOKEN;issecret=true]$AZURE_STORAGE_SAS_TOKEN"

      curl -fsSL https://get.pulumi.com | sh
      
      pulumi login -c azblob://unocash -C UnoCash.Pulumi
      pulumi stack select dev -c -C UnoCash.Pulumi --secrets-provider="azurekeyvault://$(secrets-provider-keyvault-name).vault.azure.net/keys/pulumi"

      pulumi preview -C UnoCash.Pulumi

# Awaiting support for --secrets-provider
#- task: Pulumi@1
#  displayName: Preview infrastructure changes
#  inputs:
#    azureSubscription: $(azure-subscription)
#    command: preview
#    loginArgs: -c azblob://unocash
#    cwd: UnoCash.Pulumi
#    stack: dev