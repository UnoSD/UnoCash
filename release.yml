pool:
  vmImage: ubuntu-latest

steps:

- task: AzureCLI@2
  displayName: Create Pulumi backend storage account
  inputs:
    azureSubscription: $(azure-subscription)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az group create -l westeurope -n Pulumi
      az storage account create -n $(backend-storage-account-name) -g Pulumi -l westeurope --sku Standard_LRS
      az storage container create -n unocash --account-name $(backend-storage-account-name)
      az keyvault create --location westeurope --name $(secrets-provider-keyvault-name) --resource-group Pulumi

      export SAS_END=$(date -u -d "30 minutes" '+%Y-%m-%dT%H:%MZ')
      
      echo "##vso[task.setvariable variable=AZURE_STORAGE_ACCOUNT]$(backend-storage-account-name)"
      echo "##vso[task.setvariable variable=AZURE_STORAGE_SAS_TOKEN;issecret=true]$(az storage account generate-sas --permissions cdlruwap --account-name $(backend-storage-account-name) --services b --resource-types sco --expiry $SAS_END -o tsv)"

      curl -fsSL https://get.pulumi.com | sh
      
      pulumi login -c azblob://unocash
      pulumi stack init dev --secrets-provider="azurekeyvault://$(secrets-provider-keyvault-name).vault.azure.net/keys/pulumi"

- task: Pulumi@1
  displayName: Preview infrastructure changes
  inputs:
    azureSubscription: $(azure-subscription)
    command: preview
    loginArgs: -c azblob://unocash
    args: --secrets-provider="azurekeyvault://$(secrets-provider-keyvault-name).vault.azure.net/keys/pulumi"
    cwd: UnoCash.Pulumi
    stack: dev